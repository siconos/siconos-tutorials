variables:
  os: ubuntu:18.04

image: $os

cache:
    paths:
    - .apt/
    

before_script:
   # Configure apt chaching
   - echo $CI_PROJECT_DIR
   - export APT_DIR=$CI_PROJECT_DIR/.apt && export APT_STATE_LISTS=$APT_DIR/lists && export APT_CACHE_ARCHIVES=$APT_DIR/archives
   - printf "dir::state::lists    ${APT_STATE_LISTS};\ndir::cache::archives    ${APT_CACHE_ARCHIVES};\n" > /etc/apt/apt.conf
   - mkdir -p "${APT_STATE_LISTS}/partial" && mkdir -p "${APT_CACHE_ARCHIVES}/partial"
   - apt update -qq && apt install -y -qq cmake git-core wget make
     libboost-dev libgmp-dev swig gcc gfortran g++ liblapack-dev
     libatlas-base-dev lp-solve liblpsolve55-dev python3-dev
     libpython3-dev bash swig doxygen python3-dev python3-pip htop
     libcppunit-dev python3-scipy python3-pytest valgrind



install_siconos:
  stage: build
  script:
    - "sh ci/install_siconos.sh $os" 
  artifacts:
    paths:
      - install-siconos
  only:
  - master


build_and_run_examples:
  stage: test
  script:
    - "sh ci/build_and_run_examples.sh $os"
  only:
  - master
  dependencies:
   - install_siconos


install_siconos_with_mechanisms:
  stage: test
  script:
    - "sh ci/install_siconos_with_mechanisms.sh $os" 
  only:
  - master


install_siconos:archlinux:
  stage: build
  image: base/archlinux
  before_script:
    - 'pacman -Sy && pacman --noconfirm -S - < ci/arch_linux_packages.txt'
  script:
    - "sh ci/install_siconos_with_mechanisms.sh archlinux" 
  only:
  - master
