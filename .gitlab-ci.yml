variables:
  os: ubuntu:18.04
  tag: 4.2.0
  
stages:
  - build
  - test
  - build-mechanisms
  - test-mechanisms


image: $os

cache:
    paths:
    - .apt/
    

before_script:
   # Configure apt chaching
   - echo $CI_PROJECT_DIR
   - export APT_DIR=$CI_PROJECT_DIR/.apt && export APT_STATE_LISTS=$APT_DIR/lists && export APT_CACHE_ARCHIVES=$APT_DIR/archives
   - printf "dir::state::lists    ${APT_STATE_LISTS};\ndir::cache::archives    ${APT_CACHE_ARCHIVES};\n" > /etc/apt/apt.conf
   - mkdir -p "${APT_STATE_LISTS}/partial" && mkdir -p "${APT_CACHE_ARCHIVES}/partial"
   - apt update -qq > /dev/null
   - apt install -y -qq cmake git-core wget make
     libboost-dev libgmp-dev swig gcc gfortran g++ liblapack-dev
     libatlas-base-dev lp-solve liblpsolve55-dev python3-dev
     libpython3-dev bash swig doxygen python3-pip htop
     libcppunit-dev python3-scipy python3-pytest valgrind python3-h5py > /dev/null



ubuntu:install_siconos:
  stage: build
  script:
    - "sh ci/install_siconos.sh $os" 
  artifacts:
    paths:
      - install-siconos
  only:
  - master


ubuntu:build_and_run_examples:
  stage: test
  script:
    - "sh ci/build_and_run_examples.sh $os"
  only:
  - master
  dependencies:
   - ubuntu:install_siconos
  allow_failure: true

ubuntu:install_siconos_with_mechanisms:
  stage: build-mechanisms
  script:
    - apt install -y libbullet-dev libbullet-dev libfreetype6-dev freeglut3-dev > /dev/null
    - apt install -y liboce-foundation-dev liboce-modeling-dev liboce-ocaf-dev liboce-visualization-dev > /dev/null
    - export installpath=`python3 -c "import site;print(site.USER_SITE)"`
    - "sh ci/install_oce.sh"
    - "sh ci/install_siconos_with_mechanisms.sh $os" 
  artifacts:
    paths:
      - install-siconos
      - $installpath
  only:
  - master
  allow_failure: true
  
ubuntu:build_and_run_examples_with_mechanisms:
  stage: test-mechanisms
  script:
    - apt install -y libbullet-dev libfreetype6-dev freeglut3-dev > /dev/null
    - apt install -y liboce-foundation-dev liboce-modeling-dev liboce-ocaf-dev liboce-visualization-dev > /dev/null
    - "sh ci/build_and_run_examples.sh $os"
  only:
  - master
  dependencies:
   - ubuntu:install_siconos_with_mechanisms
  allow_failure: true
  
archlinux:install_siconos_with_mechanisms:
  stage: build-mechanisms
  image: base/archlinux
  before_script:
    - 'pacman -Sy && pacman --noconfirm -S - < ci/arch_linux_packages.txt'
  script:
    - export installpath=`python3 -c "import site;print(site.USER_SITE)"`
    - "sh ci/install_oce.sh clone_oce"
    - "sh ci/install_siconos_with_mechanisms.sh archlinux"
  only:
  - master
  artifacts:
    paths:
      - install-siconos
      - $installpath
      - $HOME/install_oce
  allow_failure: true
  
archlinux:build_and_run_examples_with_mechanisms:
  stage: test-mechanisms
  image: base/archlinux
  before_script:
    - 'pacman -Sy && pacman --noconfirm -S - < ci/arch_linux_packages.txt'
  script:
    - "sh ci/build_and_run_examples.sh archlinux"
  only:
  - master
  dependencies:
   - archlinux:install_siconos_with_mechanisms
  allow_failure: true


ubuntu:siconos_examples_release:
  stage: test-mechanisms
  script:
    - apt install -y libbullet-dev libfreetype6-dev freeglut3-dev > /dev/null
    - apt install -y liboce-foundation-dev liboce-modeling-dev liboce-ocaf-dev liboce-visualization-dev > /dev/null
    - "sh ci/install_oce.sh" 
    - "sh ci/run_all_stages_release.sh $os $tag"
  only:
  - master