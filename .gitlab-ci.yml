# Templates for ci jobs
include: ci_gitlab/gitlab-ci-tutorials-templates.yml

# ---- Siconos install jobs ----
# Prepare 'Siconos ready' images
# and push them to siconos-tutorials repository.
# 
# A standard install of siconos.
# Based on siconos registry ubuntu18.04.
siconos-install:siconos-ubuntu-18.04:
  variables:
    IMAGE_NAME: siconos-ubuntu-18.04
  extends: .siconos-install

# An install of siconos with mechanisms,
# oce/pythonocc based.
siconos-install:siconos-ubuntu-18.04-with-mechanisms:
  variables:
    IMAGE_NAME: siconos-ubuntu-18.04-with-mechanisms
  extends: .siconos-install

# ---- Examples jobs ----
# Build and tests examples from tutorials
# Pull docker image 'siconos ready'
# then build, run and tests examples.

# examples, on ubuntu-18.04 with standard (default)
# Siconos installation.
examples:ubuntu-18.04:
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/siconos-ubuntu-18.04
    cdash_submit: 1
  extends: .examples-build

# examples, on ubuntu-18.04 with standard (default)
# Siconos installation.
examples:ubuntu-18.04-with-mechanisms:
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/siconos-ubuntu-18.04-with-mechanisms
  extends: .examples-build
  allow_failure: true
  when: manual

  
# This job clone, build and install siconos software  
# on archlinux os, with the 'mechanisms' config
# (release, all components, with oce and pythonocc)
# OCE and pythonocc are cloned from github repo, built and installed.
#
# Installed paths are transfered to next job (examples) using artifacts.
archlinux:install_siconos_with_mechanisms:
  stage: build-mechanisms
  image: base/archlinux
  before_script:
    - export CTEST_MODEL=$ctest_build_model
    - 'pacman -Sy && pacman --noconfirm -S - < ci/arch_linux_packages.txt'
  script:
    - "sh ci/install_oce.sh clone_oce"
    - export PYTHONPATH=$CI_PROJECT_DIR/install/site-packages
    - export OCE_INSTALL=`grep OCEConfig.cmake $CI_PROJECT_DIR/build/oce-last/install_manifest.txt| sed 's/OCEConfig.cmake//g'`
    - "sh ci/install_siconos_with_mechanisms.sh archlinux"
  only:
  - master
  artifacts:
    paths:
      - $CI_PROJECT_DIR/install/
      - install-siconos
  allow_failure: true
  
# This job clone, build and install siconos examples 
# (from siconos-tutorials), using Siconos installed in
# job 'archlinux:install_siconos_with_mechanisms' and thus
# includes all examples based on oce.
# OCE and pythonocc comes from artifacts of job archlinux:install_siconos_with_mechanisms
archlinux:build_and_run_examples_with_mechanisms:
  stage: test-mechanisms
  image: base/archlinux
  before_script:
    - export CTEST_MODEL=$ctest_build_model
    - 'pacman -Sy && pacman --noconfirm -S - < ci/arch_linux_packages.txt'
  script:
    - export PYTHONPATH=$CI_PROJECT_DIR/install/site-packages
    - export EXTRA_BUILDNAME="With Bullet and OCE"
    - "sh ci/build_and_run_examples.sh archlinux"
  only:
  - master
  dependencies:
   - archlinux:install_siconos_with_mechanisms
  allow_failure: true
  when: manual

